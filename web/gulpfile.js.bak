// See: https://markgoodyear.com/2014/01/getting-started-with-gulp/
var gulp = require('gulp'),
    concat = require('gulp-concat'),

    uglify = require('gulp-uglify'),
    cleanCSS = require('gulp-clean-css'),
    autoprefixer = require('gulp-autoprefixer'),
    htmlMin = require('gulp-htmlmin')
// var reload      = browserSync.reload;
var livereload = require('gulp-livereload');

gulp.task('browserSync', function() {
   browserSync.init({
      server: {
         baseDir: 'build'
      },
   })
})

gulp.task('html', function() {
    gulp.src(['src/**.html'])
    // .pipe(browserify())
    .pipe(htmlMin({collapseWhitespace: true}))
    .pipe(gulp.dest('build/'))
    .pipe(livereload({ start: true }));
});

gulp.task('styles', function() {   
   gulp.src(['src/styles/*.css'])
//    .pipe(browserify())
   .pipe(concat('style.css'))
   .pipe(autoprefixer('last 2 versions'))
   .pipe(cleanCSS())
   .pipe(gulp.dest('build/styles/'))
   .pipe(livereload({ start: true }));
});

gulp.task('scripts', function() {
  return gulp.src('src/scripts/**/*.js')
    // .pipe(jshint('.jshintrc'))
    // .pipe(jshint.reporter('default'))
    // .pipe(browserify())
    .pipe(concat('main.js'))
    // .pipe(gulp.dest('build/scripts/'))
    // .pipe(rename({suffix: '.min'}))
    .pipe(uglify())
    .pipe(gulp.dest('build/scripts/'))
    .pipe(livereload({ start: true }));
    // .pipe(notify({ message: 'Scripts task complete' }));
});

// create a task that ensures the `js` task is complete before
// reloading browsers
// gulp.task('res-watch', ['styles', 'html', 'scripts'], function (done) {
//     browserSync.reload();
//     done();
// });

// gulp.task('default', ['browserSync', 'styles', 'html', 'scripts'], function (){
// //    gulp.watch('src/styles/*.css', ['styles']);
// //    gulp.watch('src/**.html', ['html']);
// //    gulp.watch('src/scripts/**/*.js', ['scripts']);
//    gulp.watch('src/styles/*.css', ['res-watch']);
//    gulp.watch('src/**.html', ['res-watch']);
//    gulp.watch('src/scripts/**/*.js', ['res-watch']);
// //    gulp.watch("src/*.html").on("change", reload);
// });   

gulp.task('default', function() {
    livereload.listen({ basePath: 'build' });
    // gulp.watch('less/*.less', ['less']);
    gulp.watch('src/styles/*.css', ['styles']);
    gulp.watch('src/**.html', ['html']);
    gulp.watch('src/scripts/**/*.js', ['scripts']);
});

//ref: https://www.browsersync.io/docs/gulp